import{c as le,u as ce,F as u,r as l,j as r,S as I,B as h,C as v,I as q,M as k,s as a}from"./index-CMZTZRIn.js";import{u as ie}from"./waybill-thXhVygr.js";import{b as de,d as ue}from"./finance-DwQezXhq.js";import{R as he}from"./ArrowLeftOutlined-DFvg1iWE.js";import{D as m}from"./index-C2BMzBlI.js";import{F as me}from"./Table-Cg2wz00u.js";import{U as pe}from"./index-COEYxaOF.js";import{R as xe}from"./UploadOutlined-BYvR2IT_.js";import{I as ge}from"./index-CLfItBqF.js";import"./Pagination-BY7MwDV5.js";import"./index-CYJ1echB.js";const je="_container_cqzbg_1",fe="_header_cqzbg_6",ve="_card_cqzbg_15",p={container:je,header:fe,card:ve},Oe=()=>{var O,U,A,M,L,B,V,_,z;const{id:g}=le(),w=ce(),[C]=u.useForm(),[D,S]=l.useState(!1),[W,$]=l.useState(""),[G,J]=l.useState(""),[i,H]=l.useState([]),[K,b]=l.useState(!1),[j,Q]=l.useState([]),[x,y]=l.useState(0),[X,R]=l.useState(!1),[f]=u.useForm(),[T,N]=l.useState(!1),[t,Y]=l.useState(null);l.useEffect(()=>()=>{i.forEach(e=>{e.url&&e.url.startsWith("blob:")&&URL.revokeObjectURL(e.url)})},[i]),l.useEffect(()=>{(async()=>{if(console.log("id",g),g)try{console.log("审核页面调用接口获取详情，ID:",g);const s=await de({settlementId:g});console.log("接口返回数据:",s),s?Y(s):a.error("获取结算单详情失败")}catch(s){console.error("获取结算单详情失败:",s),a.error("获取结算单详情失败，请稍后重试")}})()},[g]),l.useEffect(()=>{console.log("fileList变化:",i)},[i]);const Z=[{title:"打款金额",dataIndex:"amountStr",key:"amountStr",width:120},{title:"银行账户",dataIndex:"payAccount",key:"payAccount",width:180},{title:"户名",dataIndex:"payAccountName",key:"payAccountName",width:200},{title:"打款凭证",dataIndex:"certificateImgUrlList",key:"certificateImgUrlList",width:200,render:(e,s)=>r.jsxs(I,{children:[e.length>0&&r.jsx(ge,{width:60,height:60,src:"http://120.26.232.36/"+e[0],preview:!1,style:{objectFit:"cover",cursor:"pointer"},onClick:()=>F(e,0)}),e.length>1&&r.jsxs(h,{size:"small",onClick:()=>F(e,0),children:["查看全部(",e.length,"张)"]})]})}],F=(e,s=0)=>{Q(e),y(s),b(!0)},ee=({fileList:e})=>{console.log("handleUpload called with:",e),i.filter(n=>!e.some(o=>o.uid===n.uid)).forEach(n=>{n.url&&n.url.startsWith("blob:")&&URL.revokeObjectURL(n.url)}),H(e)},re=async({file:e,onSuccess:s,onError:n})=>{var o,d;try{N(!0),a.loading("正在上传...",0),console.log("开始上传文件:",e.name);const c=await ie({file:e});console.log("上传成功，API返回数据:",c);const E={url:URL.createObjectURL(e),name:e.name,path:((o=c.result)==null?void 0:o.path)||((d=c.result)==null?void 0:d.url)||c.result,...c.result};console.log("返回给Upload组件的数据:",E),s(E),a.destroy(),a.success("上传成功")}catch(c){console.error("上传失败:",c),a.destroy(),a.error("上传失败"),n(c)}finally{N(!1)}},te=e=>e.type.startsWith("image/")?e.size/1024/1024<10?(console.log("文件验证通过，准备上传:",e.name),!0):(a.error("图片大小不能超过10MB!"),!1):(a.error("只能上传图片文件!"),!1),se=async e=>{!e.url&&!e.preview&&(e.preview=await ae(e.originFileObj)),$(e.url||e.preview),S(!0),J(e.name||e.url.substring(e.url.lastIndexOf("/")+1))},ae=e=>new Promise((s,n)=>{const o=new FileReader;o.readAsDataURL(e),o.onload=()=>s(o.result),o.onerror=d=>n(d)}),ne=()=>{w("/financeManage/balance")},P=async e=>{var s;if(!t){a.error("结算单数据获取失败");return}try{const n=await C.validateFields(),o=[];console.log("提交时的fileList:",i);for(const c of i)c.status==="done"&&(s=c.response)!=null&&s.path&&o.push(c.response.path);if(o.length===0){a.warning("请至少上传一张收款方网银凭证");return}const d={settlementId:t==null?void 0:t.settlementDTO.id,certificateImgUrlList:o,examineResult:e,examineResultDesc:e===1?"通过":"不通过",remark:n.auditComment};console.log("提交审核数据:",d),await ue(d),a.success("审核成功"),w("/financeManage/balance")}catch(n){console.error("审核提交失败:",n),a.error("审核提交失败，请重试")}},oe=async()=>{try{const e=await f.validateFields();if(!e.rejectReason){a.error("请输入驳回原因");return}console.log("拒绝审核:",e),a.success("审核已拒绝"),R(!1),f.resetFields(),w("/financeManage/balance")}catch(e){console.error("表单验证失败:",e)}};return t?r.jsxs("div",{className:p.container,children:[r.jsx("div",{className:p.header,children:r.jsxs(I,{children:[r.jsx(h,{icon:r.jsx(he,{}),onClick:ne,style:{background:"transparent"},children:"返回"}),r.jsxs("h2",{children:["结算单审核详情 - ",(O=t==null?void 0:t.settlementDTO)==null?void 0:O.settlementNo]})]})}),r.jsx(v,{title:"基础信息",className:p.card,children:r.jsxs(m,{column:3,bordered:!0,children:[r.jsx(m.Item,{label:"结算单号",span:1,children:(U=t==null?void 0:t.settlementDTO)==null?void 0:U.settlementNo}),r.jsx(m.Item,{label:"订单号",span:1,children:(A=t==null?void 0:t.settlementDTO)==null?void 0:A.orderNo}),r.jsx(m.Item,{label:"结算金额",span:1,children:(M=t==null?void 0:t.settlementDTO)==null?void 0:M.amountStr}),r.jsx(m.Item,{label:"收款账户",span:1,children:(B=(L=t==null?void 0:t.settlementDTO)==null?void 0:L.receiveBankCardInfo)==null?void 0:B.accountName}),r.jsx(m.Item,{label:"收款支行",span:1,children:(V=t==null?void 0:t.settlementDTO.receiveBankCardInfo)==null?void 0:V.bankBranchName}),r.jsx(m.Item,{label:"户名",span:1,children:(z=(_=t==null?void 0:t.settlementDTO)==null?void 0:_.receiveBankCardInfo)==null?void 0:z.bankName})]})}),r.jsx(v,{title:"用户上传凭证",className:p.card,children:r.jsx(me,{columns:Z,dataSource:t.settlementRemitDTOList,pagination:!1,scroll:{x:"max-content"}})}),r.jsxs(v,{title:"收款方网银凭证",className:p.card,children:[r.jsx(pe,{listType:"picture-card",fileList:i,onPreview:se,onChange:ee,beforeUpload:te,customRequest:re,maxCount:5,multiple:!1,accept:"image/*",disabled:T,children:i.length>=5?null:r.jsxs("div",{children:[r.jsx(xe,{}),r.jsx("div",{style:{marginTop:8},children:T?"上传中...":"上传凭证"})]})}),r.jsx("div",{style:{color:"#999",fontSize:"12px",marginTop:"8px"},children:"最多可上传5张图片，支持 JPG、PNG 格式，单个文件不超过10MB"})]}),r.jsx(v,{title:"备注",className:p.card,children:r.jsxs(u,{form:C,layout:"vertical",children:[r.jsx(u.Item,{name:"auditComment",rules:[{required:!0,message:"请输入"}],children:r.jsx(q.TextArea,{rows:4,placeholder:"请输入审核意见...",maxLength:500,showCount:!0})}),r.jsx(u.Item,{children:r.jsxs(I,{children:[r.jsx(h,{type:"primary",onClick:()=>P(1),size:"large",children:"审核通过"}),r.jsx(h,{danger:!0,onClick:()=>P(0),size:"large",children:"拒绝审核"})]})})]})}),r.jsx(k,{open:D,title:G,footer:null,onCancel:()=>S(!1),width:800,children:r.jsx("img",{alt:"preview",style:{width:"100%"},src:W})}),r.jsx(k,{open:K,title:`打款凭证预览 (${x+1}/${j.length})`,footer:[r.jsx(h,{onClick:()=>y(Math.max(0,x-1)),disabled:x===0,children:"上一张"},"prev"),r.jsx(h,{onClick:()=>y(Math.min(j.length-1,x+1)),disabled:x===j.length-1,children:"下一张"},"next"),r.jsx(h,{onClick:()=>b(!1),children:"关闭"},"close")],onCancel:()=>b(!1),width:800,children:j.length>0&&r.jsx("img",{alt:"voucher preview",style:{width:"100%"},src:j[x]})}),r.jsx(k,{title:"拒绝审核",open:X,onOk:oe,onCancel:()=>{R(!1),f.resetFields()},okText:"确定驳回",cancelText:"取消",width:600,okButtonProps:{danger:!0},children:r.jsx(u,{form:f,layout:"inline",children:r.jsx(u.Item,{name:"rejectReason",label:"驳回原因",rules:[{required:!0,message:"请输入驳回原因"}],children:r.jsx(q.TextArea,{rows:4,placeholder:"请输入驳回原因...",maxLength:500,style:{width:"440px"},showCount:!0})})})})]}):r.jsx("div",{className:p.container,children:r.jsx("div",{style:{textAlign:"center",padding:"50px"},children:"数据加载中..."})})};export{Oe as default};
