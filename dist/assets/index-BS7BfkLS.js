import{r as j,b as V,c as B,u as G,f as M,F as v,j as e,C as O,I as W,g as H,S as K,B as w,s as f,T}from"./index-DMKvYnLr.js";import{a as J,H as Q}from"./taskCenter-bXp4u27N.js";import{T as P}from"./index-DGhDchMJ.js";import{U as X,T as F}from"./index-C-jp-M4o.js";import{F as Y}from"./Table-34TOMWnZ.js";import{I as R}from"./index-DrbpgBqH.js";import{R as N}from"./EyeOutlined-C5Km8UI_.js";import{D as Z}from"./index-CIhK1E4t.js";import"./Pagination-D83B2W2M.js";function D(){return D=Object.assign?Object.assign.bind():function(o){for(var l=1;l<arguments.length;l++){var x=arguments[l];for(var d in x)Object.prototype.hasOwnProperty.call(x,d)&&(o[d]=x[d])}return o},D.apply(this,arguments)}const ee=(o,l)=>j.createElement(V,D({},o,{ref:l,icon:Z})),te=j.forwardRef(ee);function S(){return S=Object.assign?Object.assign.bind():function(o){for(var l=1;l<arguments.length;l++){var x=arguments[l];for(var d in x)Object.prototype.hasOwnProperty.call(x,d)&&(o[d]=x[d])}return o},S.apply(this,arguments)}const se=(o,l)=>j.createElement(V,S({},o,{ref:l,icon:X})),ie=j.forwardRef(se),ne="_priceCheckDetail_1x94g_1",ae="_modelSection_1x94g_50",re="_vehiclesList_1x94g_74",oe="_photoGrid_1x94g_100",le="_photoItem_1x94g_106",ce="_photoDescription_1x94g_117",y={priceCheckDetail:ne,modelSection:ae,vehiclesList:re,photoGrid:oe,photoItem:le,photoDescription:ce},je=()=>{const{id:o}=B(),l=G(),[x]=M(),[d]=v.useForm(),[I,$]=j.useState([]),[C,A]=j.useState({});j.useEffect(()=>{o&&(async()=>{try{const s=x.get("type"),c=s?parseInt(s):1;console.log("URL查询参数 - type:",s,"apiType:",c);let t=await J({taskId:o,type:c});$(t)}catch{f.error("获取车辆信息失败")}})()},[o,x]);const _=i=>{A(s=>({...s,[i]:!s[i]}))},E=(i,s)=>{var u,g;const c=I.find(h=>h.id===i);if(!c)return;const t=typeof s=="string"?parseFloat(s):s;if(t&&isNaN(t))return;const n=((u=c.pricingTaskCarInfoList)==null?void 0:u.length)||0,a=n>0&&t?Math.floor(t/n):null,r=d.getFieldsValue(),m={...r,models:{...r.models,[i]:{totalPrice:t}},vehicles:{...r.vehicles,[i]:{}}};(g=c.pricingTaskCarInfoList)==null||g.forEach(h=>{var p,b,k;m.vehicles[i][h.id]={actualPrice:a,remarks:((k=(b=(p=r.vehicles)==null?void 0:p[i])==null?void 0:b[h.id])==null?void 0:k.remarks)||""}}),d.setFieldsValue(m)},z=async()=>{try{const i=await d.validateFields(),s=[];if(I.forEach(n=>{var a;(a=n.pricingTaskCarInfoList)==null||a.forEach(r=>{var g,h,p,b,k,L;const m=(p=(h=(g=i.vehicles)==null?void 0:g[n.id])==null?void 0:h[r.id])==null?void 0:p.actualPrice,u=(L=(k=(b=i.vehicles)==null?void 0:b[n.id])==null?void 0:k[r.id])==null?void 0:L.remarks;m&&s.push({carId:r.id,pricingLoanAmount:m*100})})}),s.length===0){f.error("请至少为一辆车填写出款金额");return}const c=I.reduce((n,a)=>{var r;return n+(((r=a.pricingTaskCarInfoList)==null?void 0:r.length)||0)},0);s.length<c&&f.warning(`还有 ${c-s.length} 辆车未填写出款金额`),f.loading("正在提交核价结果...",0);const t={taskId:o,pricingCarResultDTOList:s};console.log("提交核价数据:",t),await Q(t),f.destroy(),f.success("核价结果提交成功"),l("/taskCenter/priceCheck")}catch(i){if(f.destroy(),i!=null&&i.errorFields){f.error("请填写完整的核价信息");const s=i.errorFields[0];s!=null&&s.name&&d.scrollToField(s.name)}else f.error("核价结果提交失败，请重试"),console.error("核价提交失败:",i)}},U=(i,s)=>{const c=[{title:"车架号",dataIndex:"vin",key:"vin",render:t=>e.jsx("span",{style:{fontFamily:"monospace",fontWeight:"bold"},children:t})},{title:"指导价(万元)",dataIndex:"guidePrice",key:"guidePrice"},{title:"生产日期",dataIndex:"productionDate",key:"productionDate",render:t=>t||"-"},{title:"里程数(km)",dataIndex:"odometer",key:"odometer",render:t=>t?`${t.toLocaleString()}`:"-"},{title:"内外饰",dataIndex:"outInColor",key:"outInColor",render:t=>t||"-"},{title:"合同金额(元)",dataIndex:"contractAmountStr",key:"contractAmountStr",render:t=>t||"-"},{title:"出款金额(元)",key:"actualPrice",width:130,render:(t,n)=>e.jsx(v.Item,{name:["vehicles",s,n.id,"actualPrice"],rules:[{required:!0,message:"请输入出款金额"}],style:{marginBottom:0},children:e.jsx(F,{style:{width:"100%"},formatter:a=>a?`${a}`.replace(/\B(?=(\d{3})+(?!\d))/g,","):"",parser:a=>a?a.replace(/\$\s?|(,*)/g,""):"",placeholder:"请输入出款金额"})})},{title:"照片",key:"photos",render:(t,n)=>{var u,g;const a=((u=n==null?void 0:n.inspectionCarDTOS)==null?void 0:u.length)||0,r=((g=n==null?void 0:n.qualityDamageImgUrlList)==null?void 0:g.length)||0,m=C[n.id]||!1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsxs("div",{style:{display:"flex",gap:"4px"},children:[e.jsxs(P,{color:"blue",children:["验车:",a]}),e.jsxs(P,{color:"orange",children:["质损:",r]})]}),e.jsx(w,{type:"link",size:"small",icon:m?e.jsx(ie,{}):e.jsx(te,{}),onClick:()=>_(n.id),style:{padding:0,height:"auto"},children:m?"收起":"展开"})]})}}];return e.jsx("div",{children:e.jsx(Y,{columns:c,dataSource:i,pagination:!1,size:"small",bordered:!0,rowKey:"id",style:{width:"100%"},expandable:{expandedRowKeys:Object.keys(C).filter(t=>C[t]),onExpand:(t,n)=>{_(n.id),setTimeout(()=>{document.querySelectorAll(".ant-table-expanded-row td").forEach(r=>{r.setAttribute("colspan","8")})},0)},columnWidth:0,expandedRowRender:t=>{var r,m,u,g;const n=((r=t==null?void 0:t.inspectionCarDTOS)==null?void 0:r.length)||0,a=((m=t==null?void 0:t.qualityDamageImgUrlList)==null?void 0:m.length)||0;return e.jsx("div",{style:{padding:"16px",background:"#fafafa"},children:e.jsxs(T,{size:"small",children:[e.jsx(T.TabPane,{tab:`验车照片 (${n})`,children:e.jsxs("div",{className:y.photoGrid,children:[(u=t.inspectionCarDTOS)==null?void 0:u.map((h,p)=>e.jsxs("div",{className:y.photoItem,children:[e.jsx(R,{src:"http://120.26.232.36"+h.fileUrl,alt:`验车照片${p+1}`,style:{width:"100%",height:150,objectFit:"cover"},preview:{mask:e.jsxs("div",{style:{color:"white",textAlign:"center"},children:[e.jsx(N,{style:{fontSize:20}}),e.jsx("div",{style:{marginTop:4},children:"预览"})]})}}),e.jsx("div",{className:y.photoDescription,children:e.jsxs("span",{children:["验车照片 ",p+1]})})]},h.id||p)),n===0&&e.jsx("div",{style:{textAlign:"center",color:"#999",padding:"20px"},children:"暂无验车照片"})]})},"inspection"),e.jsx(T.TabPane,{tab:`质损照片 (${a})`,children:e.jsxs("div",{className:y.photoGrid,children:[(g=t.qualityDamageImgUrlList)==null?void 0:g.map((h,p)=>e.jsxs("div",{className:y.photoItem,children:[e.jsx(R,{src:"http://120.26.232.36"+h,alt:`质损照片${p+1}`,style:{width:"100%",height:150,objectFit:"cover"},preview:{mask:e.jsxs("div",{style:{color:"white",textAlign:"center"},children:[e.jsx(N,{style:{fontSize:20}}),e.jsx("div",{style:{marginTop:4},children:"预览"})]})}}),e.jsx("div",{className:y.photoDescription,children:e.jsxs("span",{children:["质损照片 ",p+1]})})]},p)),a===0&&e.jsx("div",{style:{textAlign:"center",color:"#999",padding:"20px"},children:"暂无质损照片"})]})},"damage")]})})},expandIcon:()=>null}})})},q=(i,s)=>{var c;return e.jsx(O,{className:y.modelSection,style:{marginBottom:24},title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"16px"},children:[e.jsx("h3",{style:{margin:0,fontSize:"18px",fontWeight:"bold"},children:i}),e.jsxs(P,{color:"green",children:[((c=s.pricingTaskCarInfoList)==null?void 0:c.length)||0," 辆车"]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"16px"},children:e.jsx(v.Item,{name:["models",s.id,"totalPrice"],label:"总核价(元)",style:{marginBottom:"0px !important"},children:e.jsx(F,{style:{width:250},onChange:t=>E(s.id,t),placeholder:"请输入总核价",size:"large"})})})]}),children:e.jsx("div",{className:y.vehiclesList,children:U(s.pricingTaskCarInfoList||[],s.id)})},s.id)};return e.jsx("div",{className:y.priceCheckDetail,children:e.jsx(O,{children:e.jsxs(v,{form:d,layout:"inline",onFinish:z,initialValues:{orderId:o},children:[e.jsx(v.Item,{name:"orderId",label:"订单编号",rules:[{required:!0}],children:e.jsx(W,{disabled:!0})}),I==null?void 0:I.map((i,s)=>e.jsx(H.Fragment,{children:q(i.vehicleName,i)},i.id)),e.jsx(v.Item,{style:{marginTop:32,textAlign:"center"},children:e.jsxs(K,{size:"large",children:[e.jsx(w,{onClick:()=>l(-1),children:"返回"}),e.jsx(w,{type:"primary",htmlType:"submit",size:"large",children:"提交核价"})]})})]})})})};export{je as default};
