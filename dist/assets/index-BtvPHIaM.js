import{F as c,r,s as l,j as t,R as ye,a as u,I as j,S as P,B as d,M as b,G as O}from"./index-D8ReppmJ.js";import{a as fe,S as ge,D as xe,b as je,c as Te,R as we}from"./contract-g49d7uVh.js";import{u as Ce}from"./waybill-Czc8WILP.js";import{d as Se}from"./dayjs.min-BcO9To5O.js";import{S as v}from"./index-D5ba-O3m.js";import{R as ke}from"./SearchOutlined-BvVBc35E.js";import{R as Ie}from"./ReloadOutlined-C0hCzlSn.js";import{R as Fe}from"./PlusOutlined-8DBRHyq7.js";import{F as V}from"./Table-uXQ28xlW.js";import{U as Me}from"./index-DwPqOCJo.js";import{R as be}from"./UploadOutlined-BaV8lvVV.js";import"./Pagination-DkTh5KJv.js";const ve="_container_1iukc_1",H={container:ve},_e=()=>{const[T]=c.useForm(),[h]=c.useForm(),[N,R]=r.useState(!1),[B,w]=r.useState(!1),[_,x]=r.useState(!1),[q,D]=r.useState(!1),[i,p]=r.useState(null),[z,y]=r.useState([]),[L,f]=r.useState([]),[C,G]=r.useState([]),[Y,$]=r.useState(""),[U,X]=r.useState([]),[J,K]=r.useState(0),[S,k]=r.useState(1),[I,Q]=r.useState(10),[F,W]=r.useState([]),Z=async()=>{const e=await O("ContractTypeEnum");G(e);const a=await O("SignerRoleEnum");W(a)};r.useEffect(()=>{g(),Z()},[S,I]);const g=async e=>{R(!0);try{const a={page:S,pageSize:I,...e},s=await fe(a);if(console.log("....fetchData",s),s.result){const n=(s.result||[]).map(o=>({key:o.id,templateNo:o.id,name:o.templateName,createTime:o.createTime,updateTime:o.updateTime,type:o.templateType,fundContractName:o.remark||"-",templateFile:o.templateContent}));X(s.result),K(s.totalCount||0)}else l.error(s.msg||"获取数据失败")}catch(a){console.error("获取合同模板列表失败:",a),l.error("获取数据失败")}finally{R(!1)}},ee=[{title:"编号",dataIndex:"id",key:"id",width:180},{title:"名称",dataIndex:"name",key:"name",width:200},{title:"创建时间",dataIndex:"createTime",key:"createTime",width:180,render:e=>e?Se(e).format("YYYY-MM-DD HH:mm:ss"):"-"},{title:"修改时间",dataIndex:"updateTime",key:"updateTime",width:180},{title:"合同类型",dataIndex:"type",key:"type",width:120,render:e=>{const a=C.find(s=>s.value===e);return a?a.label:e}},{title:"资方合同名称",dataIndex:"capitalName",key:"capitalName",width:200},{title:"操作",key:"action",fixed:"right",width:180,render:(e,a)=>t.jsxs("span",{children:[t.jsx(d,{size:"small",type:"link",onClick:()=>ae(a),children:"编辑"}),t.jsx(d,{type:"link",size:"small",danger:!0,onClick:()=>se(a),children:"删除"}),t.jsx(d,{size:"small",type:"link",onClick:()=>ie(a),children:"设置签章位置"})]})}],te=[{title:"签署方类型",dataIndex:"signerType",key:"signerType",width:150,render:(e,a)=>{if(a.isNew)return t.jsx(v,{value:e,placeholder:"请选择签署方类型",options:F.map(n=>({label:n.desc,value:n.code})),style:{width:"100%"},onChange:n=>A(a.id,"signerType",n)});const s=F.find(n=>n.value===e);return s?s.label:e}},{title:"签章关键字",dataIndex:"keyword",key:"keyword",width:200,render:(e,a)=>a.isNew?t.jsx(j,{value:e,placeholder:"请输入签章关键字",onChange:s=>A(a.id,"keyword",s.target.value)}):e},{title:"操作",key:"action",width:150,render:(e,a)=>t.jsxs(P,{children:[a.isNew?t.jsx(d,{type:"primary",size:"small",onClick:()=>de(a),children:"添加"}):null,t.jsx(d,{type:"link",size:"small",danger:!0,onClick:()=>pe(a),children:"删除"})]})}],ae=e=>{p(e),h.setFieldsValue({name:e.name,fundContractName:e.capitalName,type:e.type}),e.templateFile?y([{uid:"-1",name:e.templateFile.split("/").pop()||"template.html",status:"done",url:e.templateFile}]):y([]),x(!0)},se=async e=>{p(e),w(!0)},ne=async()=>{try{console.log("删除模板:",i);let e=await xe({id:i.id});console.log("....res",e),l.success("删除成功"),w(!1),p(null),g()}catch(e){console.error("删除失败:",e),l.error("删除失败")}},le=async()=>{try{const e=await h.validateFields();if(z.length===0){l.error("请上传合同模版文件");return}let a={fileId:Y,name:e.name,capitalName:e.fundContractName,type:e.type};i!=null&&i.id&&(a.id=i.id),console.log("编辑模板数据:",a),await ge(a),l.success("编辑成功"),x(!1),p(null),h.resetFields(),y([]),g()}catch(e){console.error("编辑失败:",e),l.error("编辑失败")}},oe=()=>{x(!1),p(null),h.resetFields(),y([])},re={name:"file",fileList:z,accept:".html,.htm,.xhtml",maxCount:1,beforeUpload:e=>{var n;return["html","htm","xhtml"].includes(((n=e.name.split(".").pop())==null?void 0:n.toLowerCase())||"")?e.size/1024/1024<10?!0:(l.error("文件大小不能超过 10MB！"),!1):(l.error("只能上传 HTML、HTM、XHTML 格式的文件！"),!1)},customRequest:async e=>{const{file:a,onSuccess:s,onError:n}=e;console.log("....file",a),new FormData().append("file",a);try{const m=await Ce({file:a});$(m.result.id),console.log("上传成功，API返回数据:",m),s==null||s(m,a),l.success("上传成功")}catch{n==null||n(new Error("上传失败")),l.error("上传失败")}},onChange:({fileList:e})=>{y(e)},onRemove:()=>{y([])}},ie=async e=>{p(e);let a=await je({contractTemplateId:e.id});console.log("....设置签章位置",a);let s=a.result.map(n=>({id:n.id,signerType:n.signerRole,keyword:n.keyword,isNew:!1,contractTemplateId:n.contractTemplateId}));f(s),D(!0)},ce=()=>{const e={id:Date.now().toString(),signerType:"",keyword:"",isNew:!0};f([...L,e])},A=(e,a,s)=>{f(n=>n.map(o=>o.id===e?{...o,[a]:s}:o))},de=async e=>{try{if(!e.signerType||!e.keyword){l.error("请填写完整的签章位置信息");return}const a={signerRole:e.signerType,keyword:e.keyword,contractTemplateId:i==null?void 0:i.id},s=await Te(a);console.log("添加签章位置:",a);const n=F.find(m=>m.code===e.signerType),o=n?n.desc:e.signerType;l.success("签章位置添加成功"),f(m=>m.map(M=>M.id===e.id?{...M,isNew:!1,signerType:o,contractTemplateId:n.contractTemplateId}:M))}catch(a){console.error("添加签章位置失败:",a),l.error("添加签章位置失败")}},pe=e=>{console.log("....record",e),we({id:e.id}).then(a=>{console.log("....res",a),a?l.success("删除成功"):l.error("删除失败")}),f(a=>a.filter(s=>s.id!==e.id))},E=()=>{D(!1),p(null),f([])},me=async()=>{try{const e=await T.validateFields();console.log("搜索条件:",e),k(1),g(e)}catch(e){console.error("表单验证失败:",e)}},ue=()=>{T.resetFields(),k(1),g()},he=e=>{k(e.current),Q(e.pageSize)};return t.jsxs("div",{className:H.container,children:[t.jsx(c,{form:T,layout:"inline",className:H.searchForm,children:t.jsxs(ye,{gutter:24,style:{width:"100%"},children:[t.jsx(u,{span:8,children:t.jsx(c.Item,{name:"templateName",label:"模板名称",children:t.jsx(j,{placeholder:"请输入模板名称",allowClear:!0})})}),t.jsx(u,{span:8,children:t.jsx(c.Item,{name:"templateType",label:"模板类型",children:t.jsx(v,{placeholder:"请选择模板类型",options:C,allowClear:!0})})}),t.jsx(u,{span:8,children:t.jsx(c.Item,{children:t.jsxs(P,{children:[t.jsx(d,{type:"primary",icon:t.jsx(ke,{}),onClick:me,loading:N,children:"搜索"}),t.jsx(d,{icon:t.jsx(Ie,{}),onClick:ue,children:"重置"}),t.jsx(d,{icon:t.jsx(Fe,{}),type:"primary",onClick:()=>{p(null),h.resetFields(),x(!0)},children:"新增模板"})]})})})]})}),t.jsx(V,{columns:ee,dataSource:U,loading:N,pagination:{current:S,pageSize:I,total:J,showSizeChanger:!0,showQuickJumper:!0,showTotal:e=>`共 ${e} 条`},onChange:he,scroll:{x:1500},rowKey:"key"}),t.jsx(b,{title:i?"编辑合同模板":"新增合同模板",open:_,onOk:le,onCancel:oe,okText:"确认",cancelText:"取消",width:600,destroyOnClose:!0,children:t.jsxs(c,{form:h,layout:"inline",preserve:!1,children:[t.jsx(u,{span:24,children:t.jsx(c.Item,{name:"name",label:"合同名称",rules:[{required:!0,message:"请输入合同名称"},{max:20,message:"合同名称不能超过20个字符"}],children:t.jsx(j,{placeholder:"请输入合同名称",showCount:!0,maxLength:20})})}),t.jsx(u,{span:24,children:t.jsx(c.Item,{name:"fundContractName",label:"资方合同名称",children:t.jsx(j,{placeholder:"请输入资方合同名称"})})}),t.jsx(u,{span:24,children:t.jsx(c.Item,{name:"type",label:"合同类型",rules:[{required:!0,message:"请选择合同类型"}],children:t.jsx(v,{placeholder:"请选择合同类型",options:C.map(e=>({label:e.desc,value:e.code}))})})}),t.jsx(u,{span:24,children:t.jsxs(c.Item,{label:"合同模版",required:!0,children:[t.jsx(Me,{...re,children:t.jsx(d,{icon:t.jsx(be,{}),children:"选择文件"})}),t.jsx("div",{style:{marginTop:8,color:"#999",fontSize:12},children:"支持格式：HTML、HTM、XHTML，文件大小不超过10MB"})]})})]})}),t.jsxs(b,{title:"设置签章位置",open:q,onCancel:E,footer:[t.jsx(d,{onClick:E,children:"关闭"},"cancel")],width:800,destroyOnClose:!0,children:[t.jsx("div",{style:{marginBottom:16},children:t.jsx(d,{type:"primary",onClick:ce,children:"添加签章位置"})}),t.jsx(V,{columns:te,dataSource:L,pagination:!1,size:"small",locale:{emptyText:"暂无签章位置，请点击上方按钮添加"}})]}),t.jsxs(b,{title:"删除确认",open:B,onOk:ne,onCancel:()=>{w(!1),p(null)},okText:"确认",cancelText:"取消",okButtonProps:{danger:!0},children:[t.jsx("p",{children:"确定要删除该合同模板吗？"}),i&&t.jsxs("p",{style:{color:"#666",fontSize:"14px"},children:["模板编号：",i.id]})]})]})};export{_e as default};
