import{r as y,b as R,c as U,u as B,F as I,j as e,C as O,I as G,f as M,S as W,B as C,s as f,T as w}from"./index-CyB-NFsd.js";import{a as H,H as K}from"./taskCenter-DAnWHeWW.js";import{T}from"./index-DcDq0_r1.js";import{U as J,T as F}from"./index-BtCcC5gM.js";import{F as Q}from"./Table-BaXE-4d7.js";import{I as L}from"./index-DpwK3Pk4.js";import{R as N}from"./EyeOutlined-BBUHpQWg.js";import{D as X}from"./index-CyGbgfxR.js";import"./styleChecker-BxO4dLT-.js";function D(){return D=Object.assign?Object.assign.bind():function(l){for(var o=1;o<arguments.length;o++){var d=arguments[o];for(var c in d)Object.prototype.hasOwnProperty.call(d,c)&&(l[c]=d[c])}return l},D.apply(this,arguments)}const Y=(l,o)=>y.createElement(R,D({},l,{ref:o,icon:X})),Z=y.forwardRef(Y);function P(){return P=Object.assign?Object.assign.bind():function(l){for(var o=1;o<arguments.length;o++){var d=arguments[o];for(var c in d)Object.prototype.hasOwnProperty.call(d,c)&&(l[c]=d[c])}return l},P.apply(this,arguments)}const ee=(l,o)=>y.createElement(R,P({},l,{ref:o,icon:J})),te=y.forwardRef(ee),se="_priceCheckDetail_1x94g_1",ie="_modelSection_1x94g_50",ne="_vehiclesList_1x94g_74",ae="_photoGrid_1x94g_100",re="_photoItem_1x94g_106",le="_photoDescription_1x94g_117",j={priceCheckDetail:se,modelSection:ie,vehiclesList:ne,photoGrid:ae,photoItem:re,photoDescription:le},fe=()=>{const{id:l}=U(),o=B(),[d]=I.useForm(),[c,V]=y.useState([]),[k,$]=y.useState({});y.useEffect(()=>{l&&(async()=>{try{let s=await H({taskId:l,type:1});V(s)}catch{f.error("获取车辆信息失败")}})()},[l]);const _=i=>{$(s=>({...s,[i]:!s[i]}))},A=(i,s)=>{var u,g;const m=c.find(p=>p.id===i);if(!m)return;const t=typeof s=="string"?parseFloat(s):s;if(t&&isNaN(t))return;const n=((u=m.pricingTaskCarInfoList)==null?void 0:u.length)||0,a=n>0&&t?Math.floor(t/n):null,r=d.getFieldsValue(),x={...r,models:{...r.models,[i]:{totalPrice:t}},vehicles:{...r.vehicles,[i]:{}}};(g=m.pricingTaskCarInfoList)==null||g.forEach(p=>{var h,v,b;x.vehicles[i][p.id]={actualPrice:a,remarks:((b=(v=(h=r.vehicles)==null?void 0:h[i])==null?void 0:v[p.id])==null?void 0:b.remarks)||""}}),d.setFieldsValue(x)},E=async()=>{try{const i=await d.validateFields(),s=[];if(c.forEach(n=>{var a;(a=n.pricingTaskCarInfoList)==null||a.forEach(r=>{var g,p,h,v,b,S;const x=(h=(p=(g=i.vehicles)==null?void 0:g[n.id])==null?void 0:p[r.id])==null?void 0:h.actualPrice,u=(S=(b=(v=i.vehicles)==null?void 0:v[n.id])==null?void 0:b[r.id])==null?void 0:S.remarks;x&&s.push({carId:r.id,pricingLoanAmount:x})})}),s.length===0){f.error("请至少为一辆车填写出款金额");return}const m=c.reduce((n,a)=>{var r;return n+(((r=a.pricingTaskCarInfoList)==null?void 0:r.length)||0)},0);s.length<m&&f.warning(`还有 ${m-s.length} 辆车未填写出款金额`),f.loading("正在提交核价结果...",0);const t={taskId:l,pricingCarResultDTOList:s};console.log("提交核价数据:",t),await K(t),f.destroy(),f.success("核价结果提交成功"),o("/taskCenter/priceCheck")}catch(i){if(f.destroy(),i!=null&&i.errorFields){f.error("请填写完整的核价信息");const s=i.errorFields[0];s!=null&&s.name&&d.scrollToField(s.name)}else f.error("核价结果提交失败，请重试"),console.error("核价提交失败:",i)}},z=(i,s)=>{const m=[{title:"车架号",dataIndex:"vin",key:"vin",render:t=>e.jsx("span",{style:{fontFamily:"monospace",fontWeight:"bold"},children:t})},{title:"指导价(万元)",dataIndex:"guidePrice",key:"guidePrice"},{title:"生产日期",dataIndex:"productionDate",key:"productionDate",render:t=>t||"-"},{title:"里程数(km)",dataIndex:"odometer",key:"odometer",render:t=>t?`${t.toLocaleString()}`:"-"},{title:"内外饰",dataIndex:"outInColor",key:"outInColor",render:t=>t||"-"},{title:"合同金额(元)",dataIndex:"contractAmountStr",key:"contractAmountStr",render:t=>t||"-"},{title:"出款金额(元)",key:"actualPrice",width:130,render:(t,n)=>e.jsx(I.Item,{name:["vehicles",s,n.id,"actualPrice"],rules:[{required:!0,message:"请输入出款金额"}],style:{marginBottom:0},children:e.jsx(F,{style:{width:"100%"},formatter:a=>a?`${a}`.replace(/\B(?=(\d{3})+(?!\d))/g,","):"",parser:a=>a?a.replace(/\$\s?|(,*)/g,""):"",placeholder:"请输入出款金额"})})},{title:"照片",key:"photos",render:(t,n)=>{var u,g;const a=((u=n==null?void 0:n.inspectionCarDTOS)==null?void 0:u.length)||0,r=((g=n==null?void 0:n.qualityDamageImgUrlList)==null?void 0:g.length)||0,x=k[n.id]||!1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsxs("div",{style:{display:"flex",gap:"4px"},children:[e.jsxs(T,{color:"blue",children:["验车:",a]}),e.jsxs(T,{color:"orange",children:["质损:",r]})]}),e.jsx(C,{type:"link",size:"small",icon:x?e.jsx(te,{}):e.jsx(Z,{}),onClick:()=>_(n.id),style:{padding:0,height:"auto"},children:x?"收起":"展开"})]})}}];return e.jsx("div",{children:e.jsx(Q,{columns:m,dataSource:i,pagination:!1,size:"small",bordered:!0,rowKey:"id",style:{width:"100%"},expandable:{expandedRowKeys:Object.keys(k).filter(t=>k[t]),onExpand:(t,n)=>{_(n.id),setTimeout(()=>{document.querySelectorAll(".ant-table-expanded-row td").forEach(r=>{r.setAttribute("colspan","8")})},0)},columnWidth:0,expandedRowRender:t=>{var r,x,u,g;const n=((r=t==null?void 0:t.inspectionCarDTOS)==null?void 0:r.length)||0,a=((x=t==null?void 0:t.qualityDamageImgUrlList)==null?void 0:x.length)||0;return e.jsx("div",{style:{padding:"16px",background:"#fafafa"},children:e.jsxs(w,{size:"small",children:[e.jsx(w.TabPane,{tab:`验车照片 (${n})`,children:e.jsxs("div",{className:j.photoGrid,children:[(u=t.inspectionCarDTOS)==null?void 0:u.map((p,h)=>e.jsxs("div",{className:j.photoItem,children:[e.jsx(L,{src:"http://120.26.232.36"+p.fileUrl,alt:`验车照片${h+1}`,style:{width:"100%",height:150,objectFit:"cover"},preview:{mask:e.jsxs("div",{style:{color:"white",textAlign:"center"},children:[e.jsx(N,{style:{fontSize:20}}),e.jsx("div",{style:{marginTop:4},children:"预览"})]})}}),e.jsx("div",{className:j.photoDescription,children:e.jsxs("span",{children:["验车照片 ",h+1]})})]},p.id||h)),n===0&&e.jsx("div",{style:{textAlign:"center",color:"#999",padding:"20px"},children:"暂无验车照片"})]})},"inspection"),e.jsx(w.TabPane,{tab:`质损照片 (${a})`,children:e.jsxs("div",{className:j.photoGrid,children:[(g=t.qualityDamageImgUrlList)==null?void 0:g.map((p,h)=>e.jsxs("div",{className:j.photoItem,children:[e.jsx(L,{src:"http://120.26.232.36"+p,alt:`质损照片${h+1}`,style:{width:"100%",height:150,objectFit:"cover"},preview:{mask:e.jsxs("div",{style:{color:"white",textAlign:"center"},children:[e.jsx(N,{style:{fontSize:20}}),e.jsx("div",{style:{marginTop:4},children:"预览"})]})}}),e.jsx("div",{className:j.photoDescription,children:e.jsxs("span",{children:["质损照片 ",h+1]})})]},h)),a===0&&e.jsx("div",{style:{textAlign:"center",color:"#999",padding:"20px"},children:"暂无质损照片"})]})},"damage")]})})},expandIcon:()=>null}})})},q=(i,s)=>{var m;return e.jsx(O,{className:j.modelSection,style:{marginBottom:24},title:e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"16px"},children:[e.jsx("h3",{style:{margin:0,fontSize:"18px",fontWeight:"bold"},children:i}),e.jsxs(T,{color:"green",children:[((m=s.pricingTaskCarInfoList)==null?void 0:m.length)||0," 辆车"]})]}),e.jsx("div",{style:{display:"flex",alignItems:"center",gap:"16px"},children:e.jsx(I.Item,{name:["models",s.id,"totalPrice"],label:"总核价(元)",style:{marginBottom:"0px !important"},children:e.jsx(F,{style:{width:250},onChange:t=>A(s.id,t),placeholder:"请输入总核价",size:"large"})})})]}),children:e.jsx("div",{className:j.vehiclesList,children:z(s.pricingTaskCarInfoList||[],s.id)})},s.id)};return e.jsx("div",{className:j.priceCheckDetail,children:e.jsx(O,{children:e.jsxs(I,{form:d,layout:"inline",onFinish:E,initialValues:{orderId:l},children:[e.jsx(I.Item,{name:"orderId",label:"订单编号",rules:[{required:!0}],children:e.jsx(G,{disabled:!0})}),c==null?void 0:c.map((i,s)=>e.jsx(M.Fragment,{children:q(i.vehicleName,i)},i.id)),e.jsx(I.Item,{style:{marginTop:32,textAlign:"center"},children:e.jsxs(W,{size:"large",children:[e.jsx(C,{onClick:()=>o(-1),children:"返回"}),e.jsx(C,{type:"primary",htmlType:"submit",size:"large",children:"提交核价"})]})})]})})})};export{fe as default};
