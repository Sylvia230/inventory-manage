import{c as Z,u as ee,F as u,r as a,j as t,S as k,B as m,C as v,I as B,M as C,s as o}from"./index-jJHowT7b.js";import{u as te}from"./waybill-BdKFKWDt.js";import{f as w}from"./index-D2i8iU4y.js";import{o as se}from"./index-B6yg63RL.js";import{b as re}from"./finance-DMH6CxvH.js";import{R as ae}from"./ArrowLeftOutlined-CgVT4LP3.js";import{D as h}from"./index-DEcR0R2e.js";import{F as ne}from"./Table-Dbz0OIGN.js";import{U as oe}from"./index-Bp1is1uP.js";import{R as le}from"./UploadOutlined-d1WD8Bug.js";import{I as ce}from"./index-wN8e_tLH.js";import"./mobx.esm-J_RULll_.js";import"./Pagination-BWny1OkO.js";import"./index-CAebDaVx.js";const ie="_container_cqzbg_1",de="_header_cqzbg_6",ue="_card_cqzbg_15",p={container:ie,header:de,card:ue},Ne=se(()=>{const{id:x}=Z(),b=ee(),[S]=u.useForm(),[L,N]=a.useState(!1),[T,V]=a.useState(""),[_,z]=a.useState(""),[i,E]=a.useState([]),[O,y]=a.useState(!1),[f,q]=a.useState([]),[g,I]=a.useState(0),[W,R]=a.useState(!1),[j]=u.useForm(),[F,P]=a.useState(!1),[c,D]=a.useState(null);a.useEffect(()=>()=>{i.forEach(e=>{e.url&&e.url.startsWith("blob:")&&URL.revokeObjectURL(e.url)})},[i]),a.useEffect(()=>{if(x){const e=w.currentSettlement;if(e&&(e.settlementNo===x||e.id===x))console.log("审核页面从store获取数据:",e),D(e);else{const s=w.getSettlementById(x);s?(w.setCurrentSettlement(s),console.log("审核页面通过ID找到数据:",s)):(console.warn("审核页面store中没有找到数据，使用模拟数据"),D({settlementNo:x||"JS202403150001",orderNo:"YH202411060879036513",amount:15e4,payeeAccount:"6222020300012345678",payeeBranch:"中国工商银行上海分行营业部",payeeName:"上海汽车金融有限公司",status:"pending",createTime:"2024-03-15 10:00:00"}))}}},[x]),a.useEffect(()=>()=>{w.setCurrentSettlement(null)},[]),a.useEffect(()=>{console.log("fileList变化:",i)},[i]);const $=[{title:"打款金额",dataIndex:"amountStr",key:"amountStr",width:120},{title:"银行账户",dataIndex:"payAccount",key:"payAccount",width:180},{title:"户名",dataIndex:"payAccountName",key:"payAccountName",width:200},{title:"打款凭证",dataIndex:"certificateImgUrlList",key:"certificateImgUrlList",width:200,render:(e,s)=>t.jsxs(k,{children:[e.length>0&&t.jsx(ce,{width:60,height:60,src:e[0],preview:!1,style:{objectFit:"cover",cursor:"pointer"},onClick:()=>U(e,0)}),e.length>1&&t.jsxs(m,{size:"small",onClick:()=>U(e,0),children:["查看全部(",e.length,"张)"]})]})}],U=(e,s=0)=>{q(e),I(s),y(!0)},G=({fileList:e})=>{console.log("handleUpload called with:",e),i.filter(r=>!e.some(n=>n.uid===r.uid)).forEach(r=>{r.url&&r.url.startsWith("blob:")&&URL.revokeObjectURL(r.url)}),E(e)},J=async({file:e,onSuccess:s,onError:r})=>{var n,d;try{P(!0),o.loading("正在上传...",0),console.log("开始上传文件:",e.name);const l=await te({file:e});console.log("上传成功，API返回数据:",l);const M={url:URL.createObjectURL(e),name:e.name,path:((n=l.result)==null?void 0:n.path)||((d=l.result)==null?void 0:d.url)||l.result,...l.result};console.log("返回给Upload组件的数据:",M),s(M),o.destroy(),o.success("上传成功")}catch(l){console.error("上传失败:",l),o.destroy(),o.error("上传失败"),r(l)}finally{P(!1)}},H=e=>e.type.startsWith("image/")?e.size/1024/1024<10?(console.log("文件验证通过，准备上传:",e.name),!0):(o.error("图片大小不能超过10MB!"),!1):(o.error("只能上传图片文件!"),!1),Y=async e=>{!e.url&&!e.preview&&(e.preview=await K(e.originFileObj)),V(e.url||e.preview),N(!0),z(e.name||e.url.substring(e.url.lastIndexOf("/")+1))},K=e=>new Promise((s,r)=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>s(n.result),n.onerror=d=>r(d)}),Q=()=>{b("/financeManage/balance")},A=async e=>{var s;if(!c){o.error("结算单数据获取失败");return}try{const r=await S.validateFields(),n=[];console.log("提交时的fileList:",i);for(const l of i)l.status==="done"&&(s=l.response)!=null&&s.path&&n.push(l.response.path);if(n.length===0){o.warning("请至少上传一张收款方网银凭证");return}const d={settlementId:c.id,certificateImgUrlList:n,examineResult:e,examineResultDesc:e===1?"通过":"不通过",remark:r.auditComment};console.log("提交审核数据:",d),await re(d),o.success("审核成功"),b("/financeManage/balance")}catch(r){console.error("审核提交失败:",r),o.error("审核提交失败，请重试")}},X=async()=>{try{const e=await j.validateFields();if(!e.rejectReason){o.error("请输入驳回原因");return}console.log("拒绝审核:",e),o.success("审核已拒绝"),R(!1),j.resetFields(),b("/financeManage/balance")}catch(e){console.error("表单验证失败:",e)}};return c?t.jsxs("div",{className:p.container,children:[t.jsx("div",{className:p.header,children:t.jsxs(k,{children:[t.jsx(m,{icon:t.jsx(ae,{}),onClick:Q,style:{background:"transparent"},children:"返回"}),t.jsxs("h2",{children:["结算单审核详情 - ",c.settlementNo]})]})}),t.jsx(v,{title:"基础信息",className:p.card,children:t.jsxs(h,{column:3,bordered:!0,children:[t.jsx(h.Item,{label:"结算单号",span:1,children:c.settlementNo}),t.jsx(h.Item,{label:"订单号",span:1,children:c.orderNo}),t.jsx(h.Item,{label:"结算金额",span:1,children:c.amountStr}),t.jsx(h.Item,{label:"收款账户",span:1,children:c.receiveBankCardInfo.accountName}),t.jsx(h.Item,{label:"收款支行",span:1,children:c.receiveBankCardInfo.bankBranchName}),t.jsx(h.Item,{label:"户名",span:1,children:c.receiveBankCardInfo.bankName})]})}),t.jsx(v,{title:"用户上传凭证",className:p.card,children:t.jsx(ne,{columns:$,dataSource:c.settlementRemitDTOS,pagination:!1,scroll:{x:"max-content"}})}),t.jsxs(v,{title:"收款方网银凭证",className:p.card,children:[t.jsx(oe,{listType:"picture-card",fileList:i,onPreview:Y,onChange:G,beforeUpload:H,customRequest:J,maxCount:5,multiple:!1,accept:"image/*",disabled:F,children:i.length>=5?null:t.jsxs("div",{children:[t.jsx(le,{}),t.jsx("div",{style:{marginTop:8},children:F?"上传中...":"上传凭证"})]})}),t.jsx("div",{style:{color:"#999",fontSize:"12px",marginTop:"8px"},children:"最多可上传5张图片，支持 JPG、PNG 格式，单个文件不超过10MB"})]}),t.jsx(v,{title:"备注",className:p.card,children:t.jsxs(u,{form:S,layout:"vertical",children:[t.jsx(u.Item,{name:"auditComment",rules:[{required:!0,message:"请输入"}],children:t.jsx(B.TextArea,{rows:4,placeholder:"请输入审核意见...",maxLength:500,showCount:!0})}),t.jsx(u.Item,{children:t.jsxs(k,{children:[t.jsx(m,{type:"primary",onClick:()=>A(1),size:"large",children:"审核通过"}),t.jsx(m,{danger:!0,onClick:()=>A(0),size:"large",children:"拒绝审核"})]})})]})}),t.jsx(C,{open:L,title:_,footer:null,onCancel:()=>N(!1),width:800,children:t.jsx("img",{alt:"preview",style:{width:"100%"},src:T})}),t.jsx(C,{open:O,title:`打款凭证预览 (${g+1}/${f.length})`,footer:[t.jsx(m,{onClick:()=>I(Math.max(0,g-1)),disabled:g===0,children:"上一张"},"prev"),t.jsx(m,{onClick:()=>I(Math.min(f.length-1,g+1)),disabled:g===f.length-1,children:"下一张"},"next"),t.jsx(m,{onClick:()=>y(!1),children:"关闭"},"close")],onCancel:()=>y(!1),width:800,children:f.length>0&&t.jsx("img",{alt:"voucher preview",style:{width:"100%"},src:f[g]})}),t.jsx(C,{title:"拒绝审核",open:W,onOk:X,onCancel:()=>{R(!1),j.resetFields()},okText:"确定驳回",cancelText:"取消",width:600,okButtonProps:{danger:!0},children:t.jsx(u,{form:j,layout:"inline",children:t.jsx(u.Item,{name:"rejectReason",label:"驳回原因",rules:[{required:!0,message:"请输入驳回原因"}],children:t.jsx(B.TextArea,{rows:4,placeholder:"请输入驳回原因...",maxLength:500,style:{width:"440px"},showCount:!0})})})})]}):t.jsx("div",{className:p.container,children:t.jsx("div",{style:{textAlign:"center",padding:"50px"},children:"数据加载中..."})})});export{Ne as default};
